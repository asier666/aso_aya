# PR0204 - Programación de tareas con cron

[Enlace al enunciado](https://github.com/vgonzalez165/apuntes_aso/blob/main/ut02/practicas/pr0204_cron.md)

[Volver al Índice](../../index.md)

En esta práctica vamos a explorar las diferentes posibilidades de cron para crear tareas programadas en un entorno Linux

## Enunciado

Contesta a las siguientes preguntas:

1. ¿Qué orden pondrías en crontab en los siguientes casos?
`m h  dom mon dow   command`
    - La tarea se ejecuta cada hora
       
       `0 * * * *` 
    - La tarea se ejecuta los domingos cada 3 horas
       
       `0 */3 * * 0`
    - La tarea se ejecuta a las 12 de la mañana los días pares del mes.
    
        `0 12 */2 * *`
    - La tarea se ejecuta el primer día de cada mes a las 8 de la mañana y a las 8 de la tarde.

        `0 8,20 1 * *`
    - La tarea se ejecuta cada media hora de lunes a viernes.
        
        `*/30 * * * 0-6`
    - La tarea se ejecuta cada cuarto de hora, entre las 3 y las 8, de lunes a viernes, durante todo el mes de agosto
        
        `*/15 3-8 * 8 0-6`
    - La tarea se ejecuta cada 90 minutos
        `0,3,6,9`
        ``

1. ¿Cómo compruebas si el servicio cron se está ejecutando?

Ejecutando el siguiente comando, que comprueba si el servicio está en ejecución:
```
vagrant@ubuntu2204:~$ ps auxw | grep cron | grep -v grep
root        1253  0.0  0.1   6896  3048 ?        Ss   06:46   0:00 /usr/sbin/cron -f -P
```

2. ¿Cuál es el efecto de la siguiente línea `crontab`?

Se ejecutará el comando who, que sobreescribirá el contenido de `/tmp/test`, cada 15 minutos a la 1, 2 y 3 de la mañana.
```
    */15 1,2,3 * * * who > /tmp/test
```

4. Indica la ruta del fichero `crontab` del sistema

La ruta del fichero crontab del sistema se encuentra en `/etc/crontab`

5. ¿Qué ficheros controlan los usuarios que pueden utilizar el `crontab`?

Los ficheros que se encuentran en `/var/spool/cron/usuario`.

6. Excepcionalmente se debe iniciar una tarea llamada `script.sh` todos los lunes a las 07:30h antes de entrar en clase ¿Cómo lo harías?

Crearía un fichero cron con el comando `crontab -e`, que será creado en `/var/spool/cron/crontabs/usuario`. Después, lo editaría y lo dejaría de esta forma:
`30 7 * * 1 usuario script.sh`

7. Se ha cancelado la tarea. ¿Cómo listar y luego, suprimir la tarea?

Listaríamos mediante `crontab -l` y luego suprimiríamos la tarea con `crontab -r`.

8. Ejecuta el comando `ps -ef` para el usuario `root` cada 2 minutos y redirecciona el resultado a `/tmp/ps_result` sin sobrescribir los antiguos.

Esto lo haremos con `*/2 * * * * root ps -ef >> /tmp/ps_result`:
```
vagrant@ubuntu2204:~$ crontab -e
# For example, you can run a backup of all your user accounts
# at 5 a.m every week with:
# 0 5 * * 1 tar -zcf /var/backups/home.tgz /home/
#
# For more information see the manual pages of crontab(5) and cron(8)
#
# m h  dom mon dow   command
*/2 * * * * root ps -ef >> /tmp/ps_result

crontab: installing new crontab
```

2 OPCIÓN 
Editamos el fichero `/etc/crontab` y añadimos lo siguiente:
```
vagrant@ubuntu2204:~$ sudo nano /etc/crontab
# *  *  *  *  * user-name command to be executed
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
*/2 *   * * *   root    ps -ef >> /tmp/ps_result
#
```

9.  Verifica la lista de tareas en `crontab`

Empleando `crontab -l` obtenemos:
```
vagrant@ubuntu2204:~$ crontab -l
# Edit this file to introduce tasks to be run by cron.
#
# Each task to run has to be defined through a single line
# indicating with different fields when the task will be run
# and what command to run for the task
#
# To define the time you can provide concrete values for
# minute (m), hour (h), day of month (dom), month (mon),
# and day of week (dow) or use '*' in these fields (for 'any').
#
# Notice that tasks will be started based on the cron's system
# daemon's notion of time and timezones.
#
# Output of the crontab jobs (including errors) is sent through
# email to the user the crontab file belongs to (unless redirected).
#
# For example, you can run a backup of all your user accounts
# at 5 a.m every week with:
# 0 5 * * 1 tar -zcf /var/backups/home.tgz /home/
#
# For more information see the manual pages of crontab(5) and cron(8)
#
# m h  dom mon dow   command
*/2 * * * * root ps -ef >> /tmp/ps_result
```

10. Espera unos minutos y comprueba el resultado en `/tmp`



11. Crea el usuario `asir2` y prohíbele utilizar el `crontab`.

12. Verifica que el usuario `asir2` realmente no puede utilizar `crontab`

13. Programa `crontab` para que cada día a las 0:05 se eliminen todos los ficheros que se encuentran en el directorio `/tmp`.

14. Programa una tarea en el sistema que se lance de lunes a viernes a las 9 de la mañana durante los meses de verano (julio, agosto y septiembre) que escriba en un fichero la hora actual (comando `date`, aunque tienes que mirar la ayuda para elegir un formato comprensible) seguido del listado de usuarios que hay conectados en ese momento en el sistema (comando `who`)

15. El servicio `cron` se ayuda de una serie de ficheros y directorios que se encuentran en el directorio `/etc`. Explica la función de cada uno de los siguientes ficheros/directorios:
    - `cron.d`:
    - `cron.allow`:
    - `cron.deny`:
    - `cron.daily`:
    - `cron.hourly`:
    - `cron.monthly`: