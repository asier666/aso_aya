# PR0201: Usuarios y permisos

[Enlace al enunciado](https://github.com/vgonzalez165/apuntes_aso/blob/main/ut02/practicas/pr0201_usuarios_permisos.md)

[Volver al Índice](../../index.md)

En esta práctica vamos a profundizar en el ámbito de usuarios y permisos en sistemas Linux.

### Montando la máquina

Iniciamos la máquina para realizar los ejercicios en el directorio de la práctica con:
```
vagrant init generic/ubuntu2204 --minimal
```

Cuando la máquina inicie, podremos conectarnos con ```vagrant ssh``` y podremos comenzar a trabajar en la práctica.

## Realización

## 1. Permisos de usuarios
Comprobamos que estamos en el directorio personal con ```pwd```.

```
vagrant@ubuntu2204:~$ pwd
/home/vagrant
```

1. Creamos directorio pr0201 con ```mkdir pr0201```

    Creamos directorios dir1 y dir2 con ```mkdir pr0201/dir1 pr0201/dir2```

```
    vagrant@ubuntu2204:~$ ls pr0201/
    dir1    dir2
```

Comprobamos los permisos de ```dir1``` con ```ls -l -d pr0201/dir1```

Nos muestra los permisos ```drwxrwxr-x```, lo que quiere decir que es un **directorio** con permisos de lectura, escritura y ejecución para el **usuario que lo creó** y **su grupo**, pero sólo de lectura y ejecución para **el resto de usuarios**. Esto quiere decir que todos podrán **ejecutar** la carpeta (entrar en ella) y **leer** su contenido, pero sólo el dueño y su grupo podrán **escribirlo** también.

2. Para eliminar el permiso de escritura para todos emplearemos ```chmod ugo-w pr0201/dir2```

```
vagrant@ubuntu2204:~$ chmod ugo-w pr0201/dir2
vagrant@ubuntu2204:~$ ls -l pr0201/
total 8
drwxrwxr-x 2 vagrant vagrant 4096 Sep 30 11:37 dir1
dr-xr-x--x 3 vagrant vagrant 4096 Sep 30 12:03 dir2
```

3. Para eliminar el permiso de lectura del ```dir2``` para todos los usuarios, emplearemos el código octal ```551```. Los 5 indican los permisos de lectura y ejecución para el dueño y su grupo, y el 1 indica sólo el permiso de ejecución para otros usuarios. Lo aplicamos con el comando ```chmod 551 pr0201/dir2```

```
vagrant@ubuntu2204:~$ chmod 551 pr0201/dir2
vagrant@ubuntu2204:~$ ls -l pr0201/
total 8
drwxrwxr-x 2 vagrant vagrant 4096 Sep 30 11:37 dir1
dr-xr-x--x 3 vagrant vagrant 4096 Sep 30 12:03 dir2
```

1. Los permisos de ```dir2``` son los que se ven más arriba: lectura y ejecución para el dueño y grupos; y sólo ejecución para el resto de usuarios.

2. Creamos dir21 dentro de dir2 mediante ```mkdir pr0201/dir2/dir21```. No nos va a dejar porque no tenemos permisos de escritura en este directorio.

3. Para concedernos permisos de lectura en ```dir2``` emplearemos ```chmod u+w pr0201/dir2```.

Al intentar el paso 5 de nuevo, ya podremos realizarlo.
```
vagrant@ubuntu2204:~$ ls -l pr0201/dir2
total 4
drwxrwxr-x 2 vagrant vagrant 4096 Sep 30 12:03 dir21
```

## 2. Notación octal y simbólica

1. Partiendo del fichero ```file``` en nuestro directorio con los permisos ```rw-r--r--```, modificándolos con **notación simbólica** los comandos serían:

- rwxrwxr-x : ```chmod u+x file && chmod g+wx file && chmod o+wx file```
- rwxr--r-- : ```chmod u+x file```
- r--r----- : ```chmod u-w file && chmod o-r file```
- rwxr-xr-x : ```chmod u-x file && chmod ```
- rwxr-xr-x : ```chmod file```
- r-x--x--x : ```chmod file```
- -w-r----x : ```chmod file```
- -----xrwx : ```chmod file```
- r---w---x : ```chmod file```
- -w------- : ```chmod file```
- rw-r----- : ```chmod file```
- rwx--x--x : ```chmod file```

2. Modificando permisos de ```file``` mediante **notación octal**. Permisos actuales del archivo ```rw-r--r--```.

- rwxrwxrwx :
- --x--x--x :
- r---w---x :
- -w------- :
- rw-r----- :
- rwx--x--x :
- rwxr-xr-x :
- r-x--x--x :
- -w-r----x :
- -----xrwx :

## 3. El bit setgid

1. Creación del grupo ```asir```:
```
vagrant@ubuntu2204:~$ sudo groupadd asir
```
Creación de usuario1
```
vagrant@ubuntu2204:~$ sudo adduser aya1
Adding user `aya1' ...
Adding new group `aya1' (1002) ...
Adding new user `aya1' (1001) with group `aya1' ...
Creating home directory `/home/aya1' ...
Copying files from `/etc/skel' ...
New password: 
Retype new password:
passwd: password updated successfully
Changing the user information for aya1
Enter the new value, or press ENTER for the default
        Full Name []:  
        Room Number []:
        Work Phone []:
        Home Phone []:
        Other []:
Is the information correct? [Y/n] y
```
Creación de usuario2
```
vagrant@ubuntu2204:~$ sudo adduser aya2
Adding user `aya2' ...
Adding new group `aya2' (1003) ...
Adding new user `aya2' (1002) with group `aya2' ...
Creating home directory `/home/aya2' ...
Copying files from `/etc/skel' ...
New password:
Retype new password:
passwd: password updated successfully
Changing the user information for aya2
Enter the new value, or press ENTER for the default
        Full Name []:
        Room Number []:
        Work Phone []:
        Home Phone []:
        Other []:
Is the information correct? [Y/n] y
```

Buscamos el GID del grupo Asir con cat /etc/group
```
vboxsf:x:121:
asir:x:1001:
aya1:x:1002:
aya2:x:1003:
```

Incluimos a ```aya1``` y ```aya2``` como miembros del grupo ```asir```:
```
vagrant@ubuntu2204:~$ sudo usermod -a -G asir aya1
vagrant@ubuntu2204:~$ sudo usermod -a -G asir aya2
```

Comprobamos que forman parte del grupo como sigue:
```
vagrant@ubuntu2204:~$ id aya1 aya2
uid=1001(aya1) gid=1001(asir) groups=1001(asir)
uid=1002(aya2) gid=1001(asir) groups=1001(asir)
```

2. Directorio /compartido

Crear carpeta /compartido:
```
vagrant@ubuntu2204:~$ mkdir compartido
```

Asignar propietario root (UID=0) y grupo propietario asir (GID=1001):
```
vagrant@ubuntu2204:~$ sudo chown root.asir compartido/
vagrant@ubuntu2204:~$ ls -l
total 8
drwxrwxr-x 2 root    asir    4096 Oct  1 07:51 compartido
```

3. Asignar permisos de lectura, escritura y ejecución para el usuario y el grupo propietario, sin permisos para el resto:
```
vagrant@ubuntu2204:~$ sudo chmod o= compartido/
vagrant@ubuntu2204:~$ ls -l
total 8
drwxrwx--- 2 root    asir    4096 Oct  1 07:51 compartido
```

4. Añadir el bit setgid en el directorio y verificar:
```
vagrant@ubuntu2204:~$ sudo chmod g+s compartido/
vagrant@ubuntu2204:~$ ls -l
total 8
drwxrws--- 2 root    asir    4096 Oct  1 07:51 compartido
```
 5. Iniciar sesión con usuario1, acceder al directorio y crear fichero1 con contenido. Comprobar permisos

```
vagrant@ubuntu2204:~$ su aya1
Password: 

aya1@ubuntu2204:/home/vagrant$ echo "Contenido de fichero1" > compartido/fichero1 && ls -l compartido/
total 4
-rw-rw-r-- 1 aya1 asir 22 Oct  1 09:00 fichero1

```
6. Iniciar sesión con ```usuario2``` y comprobar si se puede acceder y añadir contenido a ```/compartido/fichero1```
```
aya1@ubuntu2204:/home/vagrant$ su aya2
Password:

aya2@ubuntu2204:/home/vagrant$ cat compartido/fichero1
Contenido de fichero1
aya2@ubuntu2204:/home/vagrant$ nano compartido/fichero1
aya2@ubuntu2204:/home/vagrant$ cat compartido/fichero1 
Modificado por aya2 Contenido de fichero1
```
Sí nos deja leer y modificar el archivo.

7. Preguntas:

   - ¿Qué ventajas tiene usar el bit setgid en entornos colaborativos?
        
        Nos permite de forma cómoda que todos los usuarios del grupo propietario del directorio con el bit setgid puedan leer y modificar los archivos dentro de él, facilitando a todos la colaboración.
   - ¿Qué sucede si no se aplica el bit setgid en un entorno colaborativo?
        Si no se aplica el bit setguid, los archivos de un directorio colaborativo pueden pertenecer al usuario que los creó, acarreando problemas para el resto de usuarios que tengan que trabajar con esos archivos.

8. Eliminar los usuarios y el directorio de la práctica
```
vagrant@ubuntu2204:~$ sudo userdel -r aya1
vagrant@ubuntu2204:~$ sudo userdel -r aya2
vagrant@ubuntu2204:~$ sudo rm -d -r compartido/
```

## 4. El Sticky bit

1. Crear directorio ```/compartido``` con todos los permisos para todos los usuarios:

```
vagrant@ubuntu2204:~$ mkdir compartido && chmod a=rwx compartido
vagrant@ubuntu2204:~$ ls -l
total 8
drwxrwxrwx 2 vagrant vagrant 4096 Oct  1 08:36 compartido
```

2. Crear usuarios ```usuario1``` e ```usuario2```
```
vagrant@ubuntu2204:~$ sudo adduser aya1
Adding user `aya1' ...
Adding new group `aya1' (1002) ...
Adding new user `aya1' (1001) with group `aya1' ...
Creating home directory `/home/aya1' ...
Copying files from `/etc/skel' ...
New password:
Retype new password:
passwd: password updated successfully
Changing the user information for aya1
Enter the new value, or press ENTER for the default
        Full Name []:
        Room Number []:
        Work Phone []:
        Home Phone []:
        Other []:
Is the information correct? [Y/n] y 
vagrant@ubuntu2204:~$ sudo adduser aya2
Adding user `aya2' ...
Adding new group `aya2' (1003) ...
Adding new user `aya2' (1002) with group `aya2' ...
Creating home directory `/home/aya2' ...
Copying files from `/etc/skel' ...
New password: 
Retype new password:
passwd: password updated successfully
Changing the user information for aya2
Enter the new value, or press ENTER for the default
        Full Name []:
        Room Number []:
        Work Phone []:
        Home Phone []:
        Other []:
Is the information correct? [Y/n] y
```

3. Entrar con ```aya1```, crear un fichero e intentar elminarlo con ```aya2```.
```
vagrant@ubuntu2204:~$ su aya1
Password: 
aya1@ubuntu2204:/home/vagrant$ touch compartido/file
```
```
aya1@ubuntu2204:/home/vagrant$ su aya2
Password:
aya2@ubuntu2204:/home/vagrant$ rm compartido/file 
rm: remove write-protected regular empty file 'compartido/file'? y
```

4. Activar el **Sticky bit** y verificar que se ve:
```
vagrant@ubuntu2204:~$ chmod +t compartido/
vagrant@ubuntu2204:~$ ls -l
total 8
drwxrwxrwt 2 vagrant vagrant 4096 Oct  1 08:44 compartido
```

5. Entrar de nuevo con ```aya1```, crear un fichero e intentar elminarlo con ```aya2``` otra vez.
```
vagrant@ubuntu2204:~$ su aya1
Password:
aya1@ubuntu2204:/home/vagrant$ touch compartido/file2
aya1@ubuntu2204:/home/vagrant$ su aya2
Password:
aya2@ubuntu2204:/home/vagrant$ rm compartido/file2
rm: remove write-protected regular empty file 'compartido/file2'? y
rm: cannot remove 'compartido/file2': Operation not permitted
```
6. Preguntas
   - ¿Qué efecto tiene el sticky bit en un directorio?
    
        Permite que cualquier usuario pueda acceder a dicho directorio con permisos de escritura, pero impidiéndole borrar un archivo que pertenezca a otro usuario.

   - Si tienes habilitado el sticky bit, ¿cómo tendrías que hacer para eliminar un fichero dentro del directorio?


## 5. El fichero ```/etc/shadow``` (OPCIONAL)

1. Crear un usuario llamado **aya** con contraseña ```asir1```.
```
vagrant@ubuntu2204:~$ sudo adduser aya
Adding user `aya' ...
Adding new group `aya' (1004) ...
Adding new user `aya' (1003) with group `aya' ...
Creating home directory `/home/aya' ...
Copying files from `/etc/skel' ...
New password:
Retype new password:
passwd: password updated successfully
Changing the user information for aya
Enter the new value, or press ENTER for the default
        Full Name []:
        Room Number []:
        Work Phone []:
        Home Phone []:
        Other []:
Is the information correct? [Y/n] y
```


2. Mostrar la línea de ```/etc/shadow``` que contiene la contraseña del usuario.

3. Diferentes tipos de **hash** soportados por este fichero:

4. Tipo de **hash** utilizado en el sistema:

5. ¿Para qué sirve el segundo campo del hash llamada **sal**?

6. Ataques de diccionario y tablas rainbow

7. Verificar que el hash del fichero ```/etc/shadow``` es el hash de la contraseña ```asir1```





## 6. Rompiendo hashes con John the Ripper (OPCIONAL)
